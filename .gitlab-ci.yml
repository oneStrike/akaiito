stages:
  - build
  - docker

variables:
  ADMIN: 'asherith/admin'
  CLIENT: 'asherith/client'
  SERVER: 'asherith/server'
  PNPM_REGISTRY: 'https://registry.npmmirror.com'
  DOCKER_REGISTRY: 'registry.cn-hangzhou.aliyuncs.com'
  DOCKER_USER: 'Asherith'
  DOCKER_PASS: 'li259158'
  CURRENT_PROJECT: ''
  CURRENT_IMAGE: ''
  CURRENT_IMAGE_STAGE: ''

cache:
  key: cache-$CI_COMMIT_REF_NAME
  paths:
    - node_modules/
    - pnpm-lock.yaml

default:
  tags:
    - akaiito
  artifacts:
    paths:
      - .gitlab-ci.yml
      - Dockerfile

.build_job:
  image: node:18-alpine
  after_script:
    - corepack enable
    - pnpm config set registry $PNPM_REGISTRY
    - pnpm install -F @akaiito/$CURRENT_PROJECT --frozen-lockfile
    - pnpm -C packages/$CURRENT_PROJECT build
  artifacts:
    paths:
      - packages/$CURRENT_PROJECT/dist/
      - packages/utils/lib/
      - Dockerfile
      - .dockerignore
  only:
    changes:
      - packages/$CURRENT_PROJECT/**/*
      - .gitlab-ci.yml
      - Dockerfile

.docker_job:
  after_script:
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker rm -f $CURRENT_IMAGE || true
    - docker rmi -f $CURRENT_IMAGE || true
    - docker build . --target $CURRENT_IMAGE_STAGE --tag $CURRENT_IMAGE
    - docker tag $CURRENT_IMAGE $CURRENT_IMAGE:latest
    - docker push $CURRENT_IMAGE:latest

admin_build:
  stage: build
  extends:
    - .build_job
  script:
    - echo $CURRENT_PROJECT
  variables:
    CURRENT_PROJECT: 'admin'

admin_docker:
  stage: docker
  extends:
    - .docker_job
  variables:
    CURRENT_IMAGE: $DOCKER_REGISTRY/$ADMIN
    CURRENT_IMAGE_STAGE: 'admin'
  script:
    - echo $CURRENT_IMAGE

client_build:
  stage: build
  extends:
    - .build_job
  script:
    - echo $CURRENT_PROJECT
  variables:
    CURRENT_PROJECT: 'client'

client_docker:
  stage: docker
  extends:
    - .docker_job
  script:
    - echo $CURRENT_IMAGE
  variables:
    CURRENT_IMAGE: $DOCKER_REGISTRY/$CLIENT
    CURRENT_IMAGE_STAGE: 'client'

server_build:
  stage: build
  extends:
    - .build_job
  script:
    - echo $CURRENT_PROJECT
  variables:
    CURRENT_PROJECT: 'client'

server_docker:
  stage: docker
  extends:
    - .docker_job
  script:
    - echo $CURRENT_IMAGE
  variables:
    CURRENT_IMAGE: $DOCKER_REGISTRY/$SERVER
    CURRENT_IMAGE_STAGE: 'server'
