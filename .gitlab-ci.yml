stages:
  - build
  - docker

variables:
  ADMIN: 'asherith/admin'
  CLIENT: 'asherith/client'
  SERVER: 'asherith/server'
  PNPM_REGISTRY: 'https://registry.npmmirror.com'
  DOCKER_REGISTRY: 'registry.cn-hangzhou.aliyuncs.com'
  DOCKER_USER: 'Asherith'
  DOCKER_PASS: 'li259158'

cache:
  key: cache-${CI_COMMIT_REF_NAME}
  paths:
    - node_modules/
    - pnpm-lock.yaml

admin_build:
  stage: build
  image: node:18-alpine
  tags:
    - akaiito
  script:
    - corepack enable && pnpm config set registry $PNPM_REGISTRY
    - pnpm install -F "@akaiito/admin" --frozen-lockfile
    - pnpm -C packages/admin build
    - gitlab-runner trigger admin_docker
  artifacts:
    paths:
      - packages/admin/dist/
      - Dockerfile
      - .dockerignore
  only:
    changes:
      - packages/admin/**/*
      - .gitlab-ci.yml
      - Dockerfile

admin_docker:
  stage: docker
  tags:
    - akaiito
  #  needs: ['admin_build']
  when: manual
  artifacts:
    paths:
      - packages/admin/dist/
      - Dockerfile
  script:
    - docker rm -f $DOCKER_REGISTRY/$ADMIN || true
    - docker rmi -f $DOCKER_REGISTRY/$ADMIN || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target ADMIN --tag $ADMIN
    - docker tag $ADMIN $DOCKER_REGISTRY/$ADMIN:latest
    - docker push $DOCKER_REGISTRY/$ADMIN:latest

client_build:
  stage: build
  image: node:18-alpine
  tags:
    - akaiito
  script:
    - corepack enable && pnpm config set registry $PNPM_REGISTRY
    - pnpm install -F "@akaiito/client" --frozen-lockfile
    - pnpm -C packages/client build
    - gitlab-runner trigger client_docker
  artifacts:
    paths:
      - packages/client/dist
      - Dockerfile
  only:
    changes:
      - packages/client/**/*
      - .gitlab-ci.yml
      - Dockerfile

client_docker:
  stage: docker
  tags:
    - akaiito
  #  needs: ['client_build']
  artifacts:
    paths:
      - packages/client/dist/
      - Dockerfile
      - .dockerignore
  script:
    - docker rm -f $DOCKER_REGISTRY/$CLIENT || true
    - docker rmi -f $DOCKER_REGISTRY/$CLIENT || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target CLIENT --tag $CLIENT
    - docker tag $CLIENT $DOCKER_REGISTRY/$CLIENT:latest
    - docker push $DOCKER_REGISTRY/$CLIENT:latest

server_build:
  stage: build
  image: node:18-alpine
  tags:
    - akaiito
  script:
    - corepack enable && pnpm config set registry $PNPM_REGISTRY
    - pnpm install -F "@akaiito/server" --frozen-lockfile
    - pnpm -C packages/server build
    - gitlab-runner trigger server_docker
  artifacts:
    paths:
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile
      - .dockerignore
  only:
    changes:
      - packages/server/**/*
      - .gitlab-ci.yml
      - Dockerfile

server_docker:
  stage: docker
  tags:
    - akaiito
  #  needs: ['server_build']
  artifacts:
    paths:
      - packages/server/dist/
      - packages/utils/dist
      - Dockerfile
  script:
    - docker rm -f $DOCKER_REGISTRY/$SERVER || true
    - docker rmi -f $DOCKER_REGISTRY/$SERVER || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target SERVER --tag $SERVER
    - docker tag $CLIENT $DOCKER_REGISTRY/$SERVER:latest
    - docker push $DOCKER_REGISTRY/$SERVER:latest
