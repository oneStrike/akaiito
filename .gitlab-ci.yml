stages:
  - build
  - docker

variables:
  ADMIN: 'asherith/admin'
  CLIENT: 'asherith/client'
  SERVER: 'asherith/server'
  PNPM_REGISTRY: 'https://registry.npmmirror.com'
  DOCKER_REGISTRY: 'registry.cn-hangzhou.aliyuncs.com'
  DOCKER_USER: 'Asherith'
  DOCKER_PASS: 'li259158'

cache:
  key: cache-${CI_COMMIT_REF_NAME}
  paths:
    - node_modules/
    - pnpm-lock.yaml

build:
  stage: build
  image: $DOCKER_REGISTRY/asherith/node:latest
  tags:
    - akaiito

  script:
    - corepack enable
    - pnpm config set registry $PNPM_REGISTRY
    - pnpm install --frozen-lockfile
    - pnpm run -r build
  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile

docker:
  stage: docker
  tags:
    - akaiito
  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile
  script:
    - docker rm -f $ADMIN $CLIENT $SERVER || true
    - docker rmi -f $ADMIN $CLIENT $SERVER || true
    - docker build . --target ADMIN --tag $ADMIN
    - docker build . --target CLIENT --tag $CLIENT
    - docker build . --target SERVER --tag $SERVER
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker tag $ADMIN $DOCKER_REGISTRY/$ADMIN:latest
    - docker push $DOCKER_REGISTRY/$ADMIN:latest
    - docker tag $CLIENT $DOCKER_REGISTRY/$CLIENT:latest
    - docker push $DOCKER_REGISTRY/$CLIENT:latest
    - docker tag $SERVER $DOCKER_REGISTRY/$SERVER:latest
    - docker push $DOCKER_REGISTRY/$SERVER:latest
