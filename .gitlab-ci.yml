stages:
  - build
  - docker

variables:
  Admin: 'asherith/admin'
  Client: 'asherith/client'
  Server: 'asherith/server'
  PnpmRegistry: 'https://registry.npmmirror.com'
  DOCKER_USER: 'Asherith'
  DOCKER_PASS: 'li259158'
  LOCKFILE: pnpm-lock.yaml

cache:
  key: cache-${CI_COMMIT_REF_NAME}
  paths:
    - node_modules/

build:
  stage: build
  image: asherith/node
  tags:
    - akaiito
  script:
    - corepack enable
    - pnpm config set registry $PnpmRegistry
    - pnpm install --frozen-lockfile
    - pnpm run -r build

  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile
    name: build artefacts

docker:
  stage: docker
  tags:
    - akaiito
  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile
  script:
    - docker rmi -f $Admin $Client $Server || true
    - docker rm -f $Admin $Client $Server || true
    - docker build . --target admin --tag $Admin
    - docker build . --target client --tag $Client
    - docker build . --target server --tag $Server
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS registry.cn-hangzhou.aliyuncs.com
    - docker push $Admin
    - docker push $Client
    - docker push $Server
