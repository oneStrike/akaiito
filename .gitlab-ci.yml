stages:
  - build
  - docker

variables:
  Admin: 'asherith/admin'
  Client: 'asherith/client'
  Server: 'asherith/server'
  PnpmRegistry: 'https://registry.npmmirror.com'
  LOCKFILE: pnpm-lock.yaml

cache:
  key: cache-${CI_COMMIT_REF_NAME}
  paths:
    - node_modules/

build:
  stage: build
  tags:
    - akaiito
  script:
    - corepack enable
    - pnpm config set registry $PnpmRegistry
    - pnpm install --frozen-lockfile
    - pnpm run -r build
    - pnpm --filter @akaiito/server --prod deploy pruned
  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/
      - packages/utils/
      - Dockerfile
    exclude:
      - packages/utils/node_modules
    name: build artefacts

docker:
  stage: docker
  tags:
    - akaiito
  artifacts:
    paths:
      - packages/admin/dist/
      - packages/client/dist/
      - packages/server/
      - packages/utils/
      - Dockerfile
  script:
    - docker rmi -f $Admin $Client $Server || true
    - docker rm -f $Admin $Client $Server || true
    - docker build . --target admin --tag $Admin
    - docker build . --target client --tag $Client
    - docker build . --target server --tag $Server
#    - docker login -u $DOCKER_USER -p $DOCKER_PASS
#    - docker build -t $Admin.
#    - docker push $Admin
#    - docker build -t $Client.
#    - docker push $Client
#    - docker build -t $Server.
#    - docker push $Server
