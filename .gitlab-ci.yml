stages:
  - pnpm
  - admin_build
  - client_build
  - server_build
  - admin_docker
  - client_docker
  - server_docker

variables:
  ADMIN: 'asherith/admin'
  CLIENT: 'asherith/client'
  SERVER: 'asherith/server'
  PNPM_REGISTRY: 'https://registry.npmmirror.com'
  DOCKER_REGISTRY: 'registry.cn-hangzhou.aliyuncs.com'
  DOCKER_USER: 'Asherith'
  DOCKER_PASS: 'li259158'

cache:
  key: cache-${CI_COMMIT_REF_NAME}
  paths:
    - node_modules/
    - pnpm-lock.yaml

pnpm:
  stage: none
  image: $DOCKER_REGISTRY/node:18-alpine
  script:
    - corepack enable
    - pnpm config set registry $PNPM_REGISTRY

admin_build:
  stage: admin_build
  extends: pnpm
  script:
    - pnpm install -F "@akaiito/admin" --frozen-lockfile
    - pnpm -C packages/admin build
  artifacts:
    paths:
      - packages/admin/dist/
      - Dockerfile
  only:
    changes:
      - packages/admin/**/*
      - .gitlab-ci.yml
      - Dockerfile

admin_docker:
  stage: admin_docker
  artifacts:
    paths:
      - packages/admin/dist/
      - Dockerfile
  script:
    - docker rm -f $DOCKER_REGISTRY/$ADMIN || true
    - docker rmi -f $DOCKER_REGISTRY/$ADMIN || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target ADMIN --tag $ADMIN
    - docker tag $ADMIN $DOCKER_REGISTRY/$ADMIN:latest
    - docker push $DOCKER_REGISTRY/$ADMIN:latest
  only:
    changes:
      - packages/admin/**/*
      - .gitlab-ci.yml
      - Dockerfile

client_build:
  stage: client_build
  image: node:18-alpine
  extends: pnpm
  script:
    - pnpm install -F "@akaiito/client" --frozen-lockfile
    - pnpm -C packages/client build
  artifacts:
    paths:
      - packages/client/dist
      - Dockerfile
  only:
    changes:
      - packages/client/**/*
      - .gitlab-ci.yml
      - Dockerfile

client_docker:
  stage: client_docker
  image: node:18-alpine
  artifacts:
    paths:
      - packages/client/dist/
      - Dockerfile
  script:
    - docker rm -f $DOCKER_REGISTRY/$CLIENT || true
    - docker rmi -f $DOCKER_REGISTRY/$CLIENT || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target CLIENT --tag $CLIENT
    - docker tag $CLIENT $DOCKER_REGISTRY/$CLIENT:latest
    - docker push $DOCKER_REGISTRY/$CLIENT:latest
  only:
    changes:
      - packages/client/**/*
      - .gitlab-ci.yml
      - Dockerfile

server_build:
  stage: server_build
  image: $DOCKER_REGISTRY/asherith/node:latest
  extends: pnpm
  script:
    - pnpm install -F "@akaiito/server" --frozen-lockfile
    - pnpm -C packages/server build
  artifacts:
    paths:
      - packages/server/dist
      - packages/utils/dist
      - Dockerfile
  only:
    changes:
      - packages/server/**/*
      - .gitlab-ci.yml
      - Dockerfile

server_docker:
  stage: server_docker
  image: $DOCKER_REGISTRY/asherith/node:latest
  artifacts:
    paths:
      - packages/server/dist/
      - packages/utils/dist
      - Dockerfile
  script:
    - docker rm -f $DOCKER_REGISTRY/$SERVER || true
    - docker rmi -f $DOCKER_REGISTRY/$SERVER || true
    - docker login --username=$DOCKER_USER --password=$DOCKER_PASS $DOCKER_REGISTRY
    - docker build . --target SERVER --tag $SERVER
    - docker tag $CLIENT $DOCKER_REGISTRY/$SERVER:latest
    - docker push $DOCKER_REGISTRY/$SERVER:latest
  only:
    changes:
      - packages/server/**/*
      - .gitlab-ci.yml
      - Dockerfile
